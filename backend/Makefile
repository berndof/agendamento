# === Arquivos de Compose ===
COMPOSE_DEV := docker compose -f docker-compose.yml -f docker-compose.dev.yml
COMPOSE_PROD := docker compose -f docker-compose.yml -f docker-compose.prod.yml

# === Targets ===
.PHONY: help install up-services run dev run-dev down prod-up logs clean nuke

# === Ajuda ===
help:
	@echo ""
	@echo "üöÄ Comandos dispon√≠veis:"
	@echo ""
	@echo "  make install      ‚Üí Prepara o ambiente local (.env.app, depend√™ncias, permiss√µes)"
	@echo "  make up-services  ‚Üí Sobe somente servi√ßos auxiliares (Postgres, Redis) em modo dev"
	@echo "  make run          ‚Üí Sobe servi√ßos e roda o app FastAPI localmente via script"
	@echo "  make dev          ‚Üí Sobe ambiente de desenvolvimento (tudo em segundo plano)"
	@echo "  make run-dev      ‚Üí Sobe ambiente com build + foreground (modo watch ou debug)"
	@echo "  make down         ‚Üí Derruba todos os containers do ambiente atual"
	@echo "  make prod-up      ‚Üí Sobe ambiente de produ√ß√£o com build e detach"
	@echo "  make logs         ‚Üí Mostra logs do container da FastAPI em tempo real"
	@echo "  make clean        ‚Üí Limpa containers, redes e volumes nomeados"
	@echo "  make nuke         ‚Üí Apaga tudo: containers, volumes e imagens de build"
	@echo ""

# === Inicializa√ß√£o ===

install:
	@echo "üì¶ Instalando depend√™ncias do projeto..."
	@uv sync
	@chmod +x ./src/scripts/run.sh || true
	@echo "‚úÖ Ambiente preparado."

# === Desenvolvimento ===

up-services:
	@$(MAKE) down
	@$(COMPOSE_DEV) up -d postgres redis

run:
	@$(MAKE) up-services
	@./src/scripts/run.sh

dev:
	@$(COMPOSE_DEV) up -d --build

run-dev:
	@$(COMPOSE_DEV) up --build

down:
	@echo "üõë Derrubando containers (se existirem)..."
	@docker compose down --remove-orphans || echo "‚ö†Ô∏è  Nenhum container ativo ou erro ignorado."

clean:
	@echo "üßπ Limpando containers, redes e volumes nomeados..."
	@docker compose down --volumes --remove-orphans || echo "‚ö†Ô∏è  Nenhum container ativo."
	@docker volume rm $$(docker volume ls -qf dangling=true) 2>/dev/null || true

# === Produ√ß√£o ===

prod-up:
	@$(COMPOSE_PROD) up --build -d

# === Logs ===

logs:
	@docker logs -f chimera_backend
